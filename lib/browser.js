!function(t){var e={};function o(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=t,o.c=e,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(i,n,function(e){return t[e]}.bind(null,n));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0)}([function(t,e){var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}();(void 0)("Loop",[],function(t,e){"use strict";var o;e&&e.id;return{setters:[],execute:function(){o=function(){function t(t){var e=t.handler,o=t.name;this.isSleeping=!1,this.ticksToSleep=-1,this.lastTickCalled=-1,this.handler=e,this.name=o,this.isDead=!1}return t.prototype.sleep=function(t){return this.ticksToSleep=t,this.isSleeping=!0,new Promise(function(t,e){})},t.prototype.destroy=function(){this.isDead=!0,this.handler=null},t.prototype.run=function(t){this.tick=t,this.ticksToSleep--,this.ticksToSleep<=0&&(this.isSleeping=!1),this.isSleeping||this.isDead||this.lastTickCalled===t||(this.lastTickCalled=t,this.handler(this))},t}(),t("Loop",o)}}}),(void 0)("Dispatcher",[],function(t,e){"use strict";var i;e&&e.id;return{setters:[],execute:function(){i=function(t){function e(){var e=t.call(this)||this,o=document.createTextNode(null);return e.addEventListener=o.addEventListener.bind(o),e.removeEventListener=o.removeEventListener.bind(o),e.dispatchEvent=o.dispatchEvent.bind(o),e}return o(e,t),e}(Node),t("Dispatcher",i)}}}),(void 0)("index",["./custom_typings","Loop","Dispatcher"],function(t,e){"use strict";var o,i,n,s,r,c,u,a;e&&e.id;return{setters:[function(t){},function(t){o=t},function(t){i=t}],execute:function(){n=60,s=1e3,r=24,c={TICK:"TICK",BEAT:"BEAT"},u=function(t){return 6e4/t/r},a=function(){function t(){var e=this;this.timerWorker=null,this.oscillator=null,this.pendingTicks=new Set,this.hasStopped=!1,this.dispatcher=null,this.bufferQueue=[],this.newLoopsQueue=[],this.tick=0,this.beat=0,this.loops={},this.T=r,this.M=4*r,this.onTick=function(o){e.incrementTicks(),e.scheduleTick(t.DEFAULT_TICKS_TO_SCHEDULE,e.getCurrentTick())},this.onBeat=function(t){e.drainRegisterLoopQueue()},this.onMessage=function(t){var o=(t.address||"").split("/");if("buffer"===o[1]&&(console.log("loop change detected"),e.bufferQueue.push(o.slice(2).join("/"))),"midi"===o[1]){if("beat"===o[2]||e.tick%24==0){e.beat++;var i=new CustomEvent(c.BEAT,{});e.dispatcher.dispatchEvent(i)}if("tick"===o[2]){i=new CustomEvent(c.TICK,{});e.dispatcher.dispatchEvent(i)}}},this.registerLoop=function(t,o){e.newLoopsQueue.push({name:t,handler:o})},this.setTempo=function(o){if(t.USE_BROWSER_CLOCK)return t.currentBrowserBPM=o,e.tickInterval=u(o),void e.timerWorker.postMessage({interval:e.tickInterval});fetch("http://"+window.location.host+"/updateBpm",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({bpm:o})}).then(function(t){console.log("BPM updated",t.json())})},this.playNote=function(t){var o=e.context,i=o.createOscillator();i.type="sine",i.frequency.value=t,i.connect(o.destination),i.start(0),e.oscillator=i,setTimeout(function(){e.oscillator.stop(0)},100)},this.getOutputs=function(t){t.enable(function(t){t?console.log("WebMidi could not be enabled.",t):console.log("WebMidi enabled!")})}}return t.prototype.init=function(t){this.setAudioContext(),this.setDispatcher(),this.setTickInterval(),this.startClock()},t.prototype.setDispatcher=function(t){void 0===t&&(t=i.Dispatcher),this.dispatcher=new t,this.dispatcher.addEventListener(c.TICK,this.onTick),this.dispatcher.addEventListener(c.BEAT,this.onBeat)},t.prototype.setAudioContext=function(t){void 0===t&&(t=AudioContext),this.context=new t},t.prototype.setTickInterval=function(e){void 0===e&&(e=n),this.tickInterval=t.calcTickInterval(e)},t.prototype.start=function(){this.hasStopped=!1,this.timerWorker.postMessage("start")},t.prototype.stop=function(){this.hasStopped=!0,this.timerWorker.postMessage("stop")},t.prototype.incrementTicks=function(){this.tick++},t.prototype.getCurrentTick=function(){return Number(this.tick)},t.prototype.drainRegisterLoopQueue=function(){for(;this.newLoopsQueue.length>0;){var t=this.loops,e=this.newLoopsQueue.pop(),i=e.name,n=e.handler;if(t[i])t[i].destroy(),delete t[i];t[i]=new o.Loop({name:i,handler:n})}},t.prototype.loadBuffer=function(t){var e=document.querySelectorAll(".buffer-script");Array.from(e).forEach(function(t){return t.remove()});var o=document.createElement("script"),i=Date.now();o.src=t+"?"+i,o.className="buffer-script",document.body.appendChild(o)},t.prototype.processLoops=function(t){var e=this;Object.keys(this.loops).forEach(function(o){e.loops[o].run(t)}),this.pendingTicks.delete(t)},t.prototype.processBuffers=function(){for(;this.bufferQueue.length;)this.loadBuffer(this.bufferQueue.shift())},t.prototype.scheduleTicks=function(e,o){var i=this.lastScheduledTickTimestamp||Date.now(),n=Date.now();if(n-i>t.LOOKAHEAD){if(console.log("scheduling"),this.hasStopped)return;for(var s=e,r=0;r<=s+1;){var c=o+r;this.pendingTicks.has(c)?r++:(this.scheduleTick(c,r),r++)}this.processBuffers(),this.lastScheduledTickTimestamp=n}},t.prototype.scheduleTick=function(t,e){this.pendingTicks.add(t),this.timerWorker.postMessage({scheduleLoop:!0,tickID:t,queueRank:e,tickInterval:this.tickInterval})},t.prototype.startTimerWorker=function(){var t=this;this.timerWorker=new Worker("/dist/browser-worker.js"),this.timerWorker.onmessage=function(e){if("tick"===e.data)t.onMessage({address:"/midi/tick"});else if(e.data&&"processLoops"===e.data.event){var o=e.data.tick;t.processLoops(o)}else console.log("message",e.data)},this.timerWorker.postMessage("start")},t.prototype.startOSCListen=function(){var e=new t.OSC.WebSocketPort({url:"ws://"+window.location.host});e.on("message",this.onMessage),e.open()},t.prototype.setupMIDI=function(t){t.enable(function(t){t?console.log("WebMidi could not be enabled.",t):console.log("WebMidi enabled!")})},t.prototype.startClock=function(){t.USE_BROWSER_CLOCK&&this.startTimerWorker(),this.startOSCListen(),this.setupMIDI(window.WebMidi)},t.prototype.setGlobals=function(){window.loop=this.registerLoop,window.setTempo=this.setTempo,window.playNote=this.playNote},t.EVENTS=c,t.LOOKAHEAD=s,t.USE_BROWSER_CLOCK=!1,t.DEFAULT_BPM=n,t.DEFAULT_TICKS_TO_SCHEDULE=100,t.currentBrowserBPM=n,t.calcTickInterval=u,t}(),t("BrowserClient",a)}}}),(void 0)("loader",["index"],function(t,e){"use strict";var o;e&&e.id;return{setters:[function(t){o=t}],execute:function(){console.log("BC",o.BrowserClient)}}})}]);