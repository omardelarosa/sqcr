var SQCR=function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=3)}([function(e,t){e.exports='!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bindTimingWorker=(e=>{let t=null,n=41,r=new Set;return o=>{if(o.data.start)console.log("starting"),t=setInterval(()=>e.postMessage("tick"),n);else if(o.data.interval)n=Number(n),clearInterval(t),t=setInterval(()=>e.postMessage("tick"),n);else if(o.data.scheduleLoop){const{tickID:t,tickInterval:n,queueRank:i}=o.data,l=parseInt(o.data.tickID);let a=setTimeout(()=>{r.has(a)&&(e.postMessage({event:"processLoops",tick:l}),r.delete(a))},i*n);r.add(a)}else if(o.data.stop){console.log("stopping");let n=0;r.forEach(e=>{n++,clearTimeout(e),r.delete(e)}),e.postMessage("canceled ticks: "+n),clearInterval(t),t=null}}}),t.default={bindTimingWorker:t.bindTimingWorker}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(0),o=self;o.onmessage=r.bindTimingWorker(o),o.postMessage("worker online!")}]);'},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Dispatcher=class{constructor(){const e=document.createTextNode(null);this.addEventListener=e.addEventListener.bind(e),this.removeEventListener=e.removeEventListener.bind(e),this.dispatchEvent=e.dispatchEvent.bind(e)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Loop=class{constructor({handler:e,name:t}){this.isSleeping=!1,this.ticksToSleep=-1,this.lastTickCalled=-1,this.handler=e.bind(this),this.name=t,this.isDead=!1}sleep(e){return this.ticksToSleep=e,this.isSleeping=!0,new Promise((e,t)=>{})}destroy(){this.isDead=!0,this.handler=null}run(e){this.tick=e,this.ticksToSleep--,this.ticksToSleep<=0&&(this.isSleeping=!1),this.isSleeping||this.isDead||this.lastTickCalled===e||(this.lastTickCalled=e,this.handler(this))}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=s(2),r=s(1),o=s(0),n=60,a=24,l={TICK:"TICK",BEAT:"BEAT"},c=e=>6e4/e/a;class u{constructor(e={}){this.timerWorker=null,this.oscillator=null,this.lastScheduledTickTimestamp=Date.now(),this.pendingTicks=new Set,this.hasStopped=!1,this.dispatcher=null,this.bufferQueue=[],this.newLoopsQueue=[],this.tick=0,this.beat=0,this.isFirstBeat=!0,this.loops={},this.useInlineWorker=!1,this.T=a,this.M=4*a,this.onTick=(e=>{this.incrementTicks(),this.scheduleTicks(u.DEFAULT_TICKS_TO_SCHEDULE,this.getCurrentTick())}),this.onFirstBeat=(e=>{}),this.onBeat=(e=>{this.isFirstBeat&&(this.onFirstBeat(e),this.isFirstBeat=!1),this.drainRegisterLoopQueue()}),this.onMessage=(e=>{const t=(e.address||"").split("/");if("buffer"===t[1]&&(console.log("loop change detected"),this.bufferQueue.push(t.slice(2).join("/"))),"midi"===t[1]){if("beat"===t[2]||this.tick%24==0){this.beat++;const e=new CustomEvent(l.BEAT,{});this.dispatcher.dispatchEvent(e)}if("tick"===t[2]){const e=new CustomEvent(l.TICK,{});this.dispatcher.dispatchEvent(e)}}}),this.registerLoop=((e,t)=>{this.newLoopsQueue.push({name:e,handler:t})}),this.setTempo=(e=>{if(!u.USE_SERVER_CLOCK)return console.log("using browser clock!"),u.currentBrowserBPM=e,this.tickInterval=c(e),void this.timerWorker.postMessage({interval:this.tickInterval});fetch(`http://${window.location.host}/updateBpm`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({bpm:e})}).then(e=>{console.log("BPM updated",e.json())})}),this.playNote=(e=>{const t=this.context,s=t.createOscillator();s.type="sine",s.frequency.value=e,s.connect(t.destination),s.start(0),this.oscillator=s,setTimeout(()=>{this.oscillator.stop(0)},100)}),this.getOutputs=(()=>{if(!u.MIDI)return[];u.MIDI.enable(function(e){e?console.log("WebMidi could not be enabled.",e):console.log("WebMidi enabled!")})});const{useInlineWorker:t}=e;this.useInlineWorker=!!t,this.init()}init(){this.setAudioContext(),this.setDispatcher(),this.setTickInterval(),this.startClock(),this.setGlobals(window)}setDispatcher(e=r.Dispatcher){this.dispatcher=new e,this.dispatcher.addEventListener(l.TICK,this.onTick),this.dispatcher.addEventListener(l.BEAT,this.onBeat)}setAudioContext(e=AudioContext){this.context=new e}setTickInterval(e=n){this.tickInterval=u.calcTickInterval(e)}start(){this.hasStopped&&(this.hasStopped=!1,this.startTimerWorker())}stop(){this.hasStopped||(this.hasStopped=!0,this.timerWorker.postMessage("stop"),this.timerWorker.terminate())}incrementTicks(){this.tick++}getCurrentTick(){return Number(this.tick)}drainRegisterLoopQueue(){for(;this.newLoopsQueue.length>0;){const e=this.loops,{name:t,handler:s}=this.newLoopsQueue.pop();if(e[t]){e[t].destroy(),delete e[t]}e[t]=new i.Loop({name:t,handler:s})}}loadBlobWorker(){if("undefined"!=typeof Blob){var e=new Blob([o],{type:"text/javascript"});this.timerWorker=new Worker(window.URL.createObjectURL(e)),this.bindTimerWorkerListeners(this.timerWorker,null),this.timerWorker.postMessage("start")}else console.warn("Unable to load fallback worker.")}loadBuffer(e){const t=document.querySelectorAll(".buffer-script");Array.from(t).forEach(e=>e.remove());const s=document.createElement("script"),i=Date.now();s.src=`${e}?${i}`,s.className="buffer-script",document.body.appendChild(s)}processLoops(e){Object.keys(this.loops).forEach(t=>{this.loops[t].run(e)}),this.pendingTicks.delete(e)}processBuffers(){for(;this.bufferQueue.length;)this.loadBuffer(this.bufferQueue.shift())}scheduleTicks(e,t){const s=this.lastScheduledTickTimestamp,i=Date.now();if(i-s>u.LOOKAHEAD){if(this.hasStopped)return;const s=e;let r=0;for(;r<=s+1;){let e=t+r;this.pendingTicks.has(e)?r++:(this.scheduleTick(e,r),r++)}this.processBuffers(),this.lastScheduledTickTimestamp=i}}scheduleTick(e,t){this.pendingTicks.add(e),this.timerWorker.postMessage({scheduleLoop:!0,tickID:e,queueRank:t,tickInterval:this.tickInterval})}bindTimerWorkerListeners(e,t){e.onmessage=(e=>{if("tick"===e.data)this.onMessage({address:"/midi/tick"});else if(e.data&&"processLoops"===e.data.event){const{tick:t}=e.data;this.processLoops(t)}else console.log("message",e.data)}),e.onerror=t}startTimerWorker(){this.useInlineWorker?this.loadBlobWorker():(this.timerWorker=new Worker(u.TIMING_WORKER_PATH),this.bindTimerWorkerListeners(this.timerWorker,e=>{this.useInlineWorker=!0,this.loadBlobWorker()}),this.timerWorker.postMessage("start"))}startOSCListen(){if(!u.OSC)return void console.warn("OSC Browser client not found!  Will not observer file changes.");let e=new u.OSC.WebSocketPort({url:`ws://${window.location.host}`});e.on("message",this.onMessage),e.open()}setupMIDI(){u.MIDI?u.MIDI.enable(function(e){e?console.log("WebMidi could not be enabled.",e):console.log("WebMidi enabled!")}):console.warn("No MIDI adaptor provided, MIDI support disabled.")}startClock(){u.USE_SERVER_CLOCK||this.startTimerWorker(),this.startOSCListen(),this.setupMIDI()}setGlobals(e){e.loop=this.registerLoop,e.setTempo=this.setTempo,e.playNote=this.playNote,e.tickInterval=this.tickInterval,e.T=this.T,e.M=this.M,e.sqcr=this,e.BrowserClient=u}}u.EVENTS=l,u.LOOKAHEAD=1e3,u.USE_SERVER_CLOCK=!1,u.DEFAULT_BPM=n,u.TIMING_WORKER_PATH="/lib/timing.worker.js",u.DEFAULT_TICKS_TO_SCHEDULE=100,u.currentBrowserBPM=n,u.calcTickInterval=c,t.BrowserClient=u,t.default=u}]).default;